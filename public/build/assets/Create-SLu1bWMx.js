import{g as x,C as K,i as V,h as W,j as Y,c as o,o as u,a as R,u as d,m as Z,w as S,b as e,s as ee,e as f,v as k,x as A,F as C,r as D,t as s,n as N,f as p,L as te,P as z,W as se}from"./app-DV6QGe5n.js";import{E as le}from"./EmployeeLayout-iir4z3Zz.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";import"./NavLink-sW0XPEdd.js";import"./DangerButton-vX3ciNPD.js";const ae={class:"flex justify-between items-center"},re={class:"text-2xl font-bold text-gray-900"},ne={class:"text-gray-600 mt-1"},oe={class:"max-w-4xl mx-auto"},ue={class:"bg-white p-6 rounded-lg shadow-sm border border-gray-200"},de={class:"space-y-4"},ie={class:"relative"},ce={key:0,class:"absolute right-3 top-2"},me={key:0,class:"mt-2 border border-gray-200 rounded-md max-h-60 overflow-y-auto"},ve=["onClick"],fe={class:"flex justify-between items-start"},pe={class:"font-medium text-blue-600"},ge={class:"text-sm text-gray-600"},be={class:"text-xs text-gray-500 mt-1"},ye={key:1,class:"mt-2 text-sm text-orange-600 bg-orange-50 p-2 rounded"},xe={key:0,class:"bg-green-50 p-4 rounded-md border border-green-200"},_e={class:"flex justify-between items-start"},he={class:"flex-1"},we={class:"flex items-center gap-2 mb-2"},je={key:0,class:"flex items-center gap-1"},ke={class:"grid grid-cols-1 md:grid-cols-2 gap-2 text-sm"},Pe={class:"capitalize"},Re={class:"capitalize"},Se={key:0},Ae={key:0,class:"bg-white p-6 rounded-lg shadow-sm border border-gray-200"},Ce={class:"text-lg font-semibold text-gray-900 mb-4"},Ne={class:"space-y-3"},Me=["onClick"],qe={class:"flex items-center justify-between"},Le={class:"flex-1"},Te={class:"font-medium"},Ve={class:"text-sm text-gray-600"},De={key:0,class:"text-xs text-gray-500 mt-1"},Oe={class:"flex items-center ml-4"},Ee=["checked"],Ue={class:"mt-4 text-sm text-gray-600"},Fe={key:0,class:"mt-3 p-3 bg-blue-50 rounded-md"},$e={class:"text-sm text-blue-800"},Be={key:1,class:"bg-white p-6 rounded-lg shadow-sm border border-gray-200"},Ie={class:"text-lg font-semibold text-gray-900 mb-4"},We={class:"grid grid-cols-1 md:grid-cols-2 gap-6"},ze={class:"block text-sm font-medium text-gray-700 mb-2"},He={class:"relative"},Xe=["max"],Je={class:"text-xs text-gray-500 mt-1"},Qe={key:0,class:"text-xs text-blue-600 mt-1"},Ge={key:1,class:"text-red-600 text-xs mt-1"},Ke=["value"],Ye={key:0,class:"text-red-600 text-xs mt-1"},Ze={class:"mt-4"},et=["placeholder"],tt={class:"text-xs text-gray-500 mt-1"},st={key:0,class:"text-red-600 text-xs mt-1"},lt={class:"mt-4"},at={class:"flex justify-end space-x-4"},rt=["disabled"],mt={__name:"Create",props:{deliveryRequest:Object,reasonOptions:Object},setup(O){const M=O,g=x(""),y=x([]),n=x(M.deliveryRequest),c=x([]),m=x(0),P=x(!1),q=x(!1),L=x(null),r=K({delivery_request_id:null,refund_amount:0,reason:"",description:"",refunded_packages:[],notes:""}),v=V(()=>n.value?n.value.payment_type==="prepaid"?"refund":"adjustment":"refund"),_=V(()=>({refund:{title:"Create Refund",description:"Process a refund for a prepaid delivery",amountLabel:"Refund Amount *",maxLabel:"Maximum Refundable",button:"Process Refund",success:"Refund processed successfully"},adjustment:{title:"Create Invoice Adjustment",description:"Adjust invoice amount for a postpaid delivery",amountLabel:"Adjustment Amount *",maxLabel:"Maximum Adjustable",button:"Apply Adjustment",success:"Invoice adjustment applied successfully"}})[v.value]),T=V(()=>{if(!n.value||v.value!=="adjustment")return 0;const l=Number(r.refund_amount)||0;return Math.max(0,n.value.total_price-l)}),E=async(l,t={})=>{try{const i=await fetch(l,{headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest",...t.headers},...t});if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);return await i.json()}catch(i){throw console.error("API fetch error:",i),i}},H=async()=>{if(!g.value.trim()){y.value=[];return}P.value=!0;try{const l=await E(route("refunds.search-delivery-requests",{search:g.value}));console.log("Search results:",l),y.value=l}catch(l){console.error("Search failed:",l),y.value=[],alert("Search failed. Please try again.")}finally{P.value=!1}};W(g,l=>{L.value&&clearTimeout(L.value),L.value=setTimeout(()=>{l.trim()?H():y.value=[]},500)});const U=l=>{console.log("Selected request:",l),n.value=l,r.delivery_request_id=l.id,y.value=[],g.value=l.reference_number,m.value=0,r.refund_amount=0,F()},F=async()=>{if(!n.value){console.log("No delivery request selected"),m.value=0;return}console.log("Calculating max refundable for:",n.value.id),console.log("Selected packages:",c.value),q.value=!0;try{const l=new URLSearchParams({delivery_request_id:n.value.id});c.value.length>0&&l.append("package_ids",JSON.stringify(c.value));const t=`${route("refunds.calculate-max-refund")}?${l.toString()}`;console.log("Calculation URL:",t);const i=await E(t);if(console.log("Max refundable calculation result:",i),i.error)throw new Error(i.error);m.value=Number(i.max_refundable)||0,r.refund_amount=Math.min(Number(r.refund_amount)||0,m.value),console.log("Max refundable set to:",m.value)}catch(l){console.error("Calculation failed:",l),X()}finally{q.value=!1}},X=()=>{if(!n.value){m.value=0;return}console.log("Using fallback calculation");let l=Number(n.value.total_price)||0;if(c.value.length>0&&n.value.packages){let t=0;n.value.packages.forEach(i=>{c.value.includes(i.id)&&(t+=Number(i.value)||0)}),l+=t}m.value=l,r.refund_amount=Math.min(Number(r.refund_amount)||0,l),console.log("Fallback calculation result:",l)},J=l=>{const t=c.value.indexOf(l);t>-1?c.value.splice(t,1):c.value.push(l),r.refunded_packages=c.value,console.log("Packages after toggle:",c.value),F()};W(()=>r.refund_amount,l=>{(Number(l)||0)>m.value&&(r.refund_amount=m.value)});const b=l=>"â‚±"+(Number(l)||0).toFixed(2),Q=()=>{if(!n.value){alert("Please select a delivery request first.");return}const l=Number(r.refund_amount)||0;if(l<=0){alert("Please enter a valid amount.");return}if(l>m.value){alert(`Amount cannot exceed maximum ${v.value==="adjustment"?"adjustable":"refundable"} amount: ${b(m.value)}`);return}if(v.value==="adjustment"&&T.value<0){alert("Adjustment cannot result in negative amount due.");return}r.post(route("refunds.store"),{preserveScroll:!0,onSuccess:()=>{se.visit(route("refunds.index"))},onError:t=>{console.error("Form errors:",t),alert("There were errors with your submission. Please check the form.")}})},G=()=>{n.value=null,r.delivery_request_id=null,c.value=[],r.refunded_packages=[],g.value="",m.value=0,r.refund_amount=0};return Y(()=>{M.deliveryRequest&&U(M.deliveryRequest)}),(l,t)=>{var i;return u(),o(C,null,[R(d(Z),{title:((i=_.value)==null?void 0:i.title)||"Create Refund/Adjustment"},null,8,["title"]),R(le,null,{header:S(()=>{var w,j;return[e("div",ae,[e("div",null,[e("h1",re,s(((w=_.value)==null?void 0:w.title)||"Create Refund/Adjustment"),1),e("p",ne,s(((j=_.value)==null?void 0:j.description)||"Process a refund or adjustment for a completed delivery"),1)]),R(d(z),{href:l.route("refunds.index"),class:"bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors"},{default:S(()=>t[5]||(t[5]=[p(" Back to List ")])),_:1},8,["href"])])]}),default:S(()=>{var w,j,$,B,I;return[e("div",oe,[e("form",{onSubmit:ee(Q,["prevent"]),class:"space-y-6"},[e("div",ue,[t[21]||(t[21]=e("h2",{class:"text-lg font-semibold text-gray-900 mb-4"},"1. Select Delivery Request",-1)),e("div",de,[e("div",null,[t[8]||(t[8]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"}," Search Delivery Request ",-1)),e("div",ie,[k(e("input",{"onUpdate:modelValue":t[0]||(t[0]=a=>g.value=a),type:"text",placeholder:"Enter reference number (e.g., INF-2025-000019) or sender name...",class:"w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"},null,512),[[A,g.value]]),P.value?(u(),o("div",ce,t[6]||(t[6]=[e("div",{class:"animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600"},null,-1)]))):f("",!0)]),t[9]||(t[9]=e("div",{class:"text-xs text-gray-500 mt-1"}," Search by reference number or sender name. Only completed, eligible deliveries are shown. ",-1)),y.value.length>0?(u(),o("div",me,[(u(!0),o(C,null,D(y.value,a=>{var h;return u(),o("div",{key:a.id,onClick:nt=>U(a),class:"p-3 border-b border-gray-100 hover:bg-gray-50 cursor-pointer"},[e("div",fe,[e("div",null,[e("div",pe,s(a.reference_number),1),e("div",ge," Sender: "+s((h=a.sender)==null?void 0:h.name)+" | Amount: "+s(b(a.total_price))+" | Type: "+s(a.payment_type==="prepaid"?"Prepaid":"Postpaid"),1),e("div",be," Status: "+s(a.status)+" | Payment: "+s(a.payment_status),1)]),e("span",{class:N([a.payment_type==="prepaid"?"bg-purple-100 text-purple-800":"bg-orange-100 text-orange-800","inline-flex px-2 py-1 text-xs font-medium rounded-full"])},s(a.payment_type==="prepaid"?"Refund":"Adjustment"),3)])],8,ve)}),128))])):f("",!0),g.value&&!P.value&&y.value.length===0?(u(),o("div",ye,[p(' No eligible delivery requests found for "'+s(g.value)+'". Make sure: ',1),t[7]||(t[7]=e("ul",{class:"list-disc list-inside mt-1"},[e("li",null,"The reference number is correct"),e("li",null,"The delivery is completed"),e("li",null,"Prepaid: Payment is verified and paid"),e("li",null,'Postpaid: Payment status is "requires_adjustment"'),e("li",null,"No refund/adjustment already exists")],-1))])):f("",!0)]),n.value?(u(),o("div",xe,[e("div",_e,[e("div",he,[e("div",we,[t[11]||(t[11]=e("h3",{class:"font-medium text-green-900"},"Selected Delivery Request:",-1)),e("span",{class:N([v.value==="refund"?"bg-purple-100 text-purple-800":"bg-orange-100 text-orange-800","inline-flex px-2 py-1 text-xs font-medium rounded-full"])},s(v.value==="refund"?"Refund":"Adjustment"),3),q.value?(u(),o("div",je,t[10]||(t[10]=[e("div",{class:"animate-spin rounded-full h-4 w-4 border-b-2 border-green-600"},null,-1),e("span",{class:"text-xs text-green-600"},"Calculating...",-1)]))):f("",!0)]),e("div",ke,[e("div",null,[t[12]||(t[12]=e("strong",null,"Reference:",-1)),p(" "+s(n.value.reference_number),1)]),e("div",null,[t[13]||(t[13]=e("strong",null,"Sender:",-1)),p(" "+s((w=n.value.sender)==null?void 0:w.name),1)]),e("div",null,[t[14]||(t[14]=e("strong",null,"Total Amount:",-1)),p(" "+s(b(n.value.total_price)),1)]),e("div",null,[t[15]||(t[15]=e("strong",null,"Payment Type:",-1)),t[16]||(t[16]=p()),e("span",Pe,s(n.value.payment_type),1)]),e("div",null,[t[17]||(t[17]=e("strong",null,"Payment Status:",-1)),t[18]||(t[18]=p()),e("span",Re,s(n.value.payment_status),1)]),e("div",null,[t[19]||(t[19]=e("strong",null,"Packages:",-1)),p(" "+s(((j=n.value.packages)==null?void 0:j.length)||0)+" items",1)]),e("div",null,[e("strong",null,s(($=_.value)==null?void 0:$.maxLabel)+":",1),p(" "+s(b(m.value)),1)]),v.value==="adjustment"?(u(),o("div",Se,[t[20]||(t[20]=e("strong",null,"New Amount Due:",-1)),p(" "+s(b(T.value)),1)])):f("",!0)])]),e("button",{onClick:G,type:"button",class:"text-red-600 hover:text-red-800 text-sm whitespace-nowrap ml-4"}," Change ")])])):f("",!0)])]),n.value&&n.value.packages&&n.value.packages.length>0?(u(),o("div",Ae,[e("h2",Ce,"2. Select Packages to "+s(v.value==="adjustment"?"Adjust":"Refund")+" (Optional)",1),e("div",Ne,[(u(!0),o(C,null,D(n.value.packages,a=>(u(),o("div",{key:a.id,onClick:h=>J(a.id),class:N([{"bg-blue-50 border-blue-200":c.value.includes(a.id),"bg-gray-50 border-gray-200":!c.value.includes(a.id)},"p-3 border rounded-md cursor-pointer transition-colors"])},[e("div",qe,[e("div",Le,[e("div",Te,s(a.item_name),1),e("div",Ve," Value: "+s(b(a.value))+" | Category: "+s(a.category)+" | Weight: "+s(a.weight)+"kg ",1),a.description?(u(),o("div",De,s(a.description),1)):f("",!0)]),e("div",Oe,[e("input",{type:"checkbox",checked:c.value.includes(a.id),class:"rounded border-gray-300 text-blue-600 focus:ring-blue-500 h-5 w-5",readonly:""},null,8,Ee)])])],10,Me))),128))]),e("div",Ue,[t[22]||(t[22]=e("strong",null,"Note:",-1)),p(" Leave all packages unselected to "+s(v.value==="adjustment"?"adjust":"refund")+" the entire delivery request amount ("+s(b(n.value.total_price))+") ",1)]),c.value.length>0?(u(),o("div",Fe,[e("div",$e," Selected "+s(c.value.length)+" package(s) for "+s(v.value==="adjustment"?"adjustment":"refund"),1)])):f("",!0)])):f("",!0),n.value?(u(),o("div",Be,[e("h2",Ie,"3. "+s(v.value==="adjustment"?"Adjustment":"Refund")+" Details",1),e("div",We,[e("div",null,[e("label",ze,s((B=_.value)==null?void 0:B.amountLabel),1),e("div",He,[t[23]||(t[23]=e("span",{class:"absolute left-3 top-2 text-gray-500"},"â‚±",-1)),k(e("input",{"onUpdate:modelValue":t[1]||(t[1]=a=>d(r).refund_amount=a),type:"number",step:"0.01",min:"0",max:m.value,required:"",class:"w-full border border-gray-300 rounded-md pl-8 pr-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"},null,8,Xe),[[A,d(r).refund_amount]])]),e("div",Je," Maximum "+s(v.value==="adjustment"?"adjustable":"refundable")+": "+s(b(m.value)),1),v.value==="adjustment"?(u(),o("div",Qe," New amount due: "+s(b(T.value)),1)):f("",!0),d(r).errors.refund_amount?(u(),o("div",Ge,s(d(r).errors.refund_amount),1)):f("",!0)]),e("div",null,[t[25]||(t[25]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"}," Reason * ",-1)),k(e("select",{"onUpdate:modelValue":t[2]||(t[2]=a=>d(r).reason=a),required:"",class:"w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"},[t[24]||(t[24]=e("option",{value:""},"Select a reason",-1)),(u(!0),o(C,null,D(O.reasonOptions,(a,h)=>(u(),o("option",{key:h,value:h},s(a),9,Ke))),128))],512),[[te,d(r).reason]]),d(r).errors.reason?(u(),o("div",Ye,s(d(r).errors.reason),1)):f("",!0)])]),e("div",Ze,[t[26]||(t[26]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"}," Description * ",-1)),k(e("textarea",{"onUpdate:modelValue":t[3]||(t[3]=a=>d(r).description=a),rows:"3",placeholder:v.value==="adjustment"?"Provide detailed explanation for the invoice adjustment...":"Provide detailed explanation for the refund...",required:"",class:"w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"},null,8,et),[[A,d(r).description]]),e("div",tt," Be specific about what went wrong and why the "+s(v.value==="adjustment"?"adjustment":"refund")+" is necessary. ",1),d(r).errors.description?(u(),o("div",st,s(d(r).errors.description),1)):f("",!0)]),e("div",lt,[t[27]||(t[27]=e("label",{class:"block text-sm font-medium text-gray-700 mb-2"}," Internal Notes (Optional) ",-1)),k(e("textarea",{"onUpdate:modelValue":t[4]||(t[4]=a=>d(r).notes=a),rows:"2",placeholder:"Any additional internal notes...",class:"w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"},null,512),[[A,d(r).notes]])])])):f("",!0),e("div",at,[R(d(z),{href:l.route("refunds.index"),class:"bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors"},{default:S(()=>t[28]||(t[28]=[p(" Cancel ")])),_:1},8,["href"]),e("button",{type:"submit",disabled:d(r).processing||!n.value,class:N([{"bg-blue-600 hover:bg-blue-700":!d(r).processing&&n.value,"bg-blue-400 cursor-not-allowed":d(r).processing||!n.value},"text-white px-6 py-2 rounded-lg transition-colors"])},s(d(r).processing?"Processing...":((I=_.value)==null?void 0:I.button)||"Process"),11,rt)])],32)])]}),_:1})],64)}}};export{mt as default};
